<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦¾èŠ’æ–°å±¿è¡¨ç›˜å•†åº—</title>
    <script src="js/supabase.min.js"></script>
    <script src="js/jszip.min.js"></script>
    <style>
        /* åŸºæœ¬æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.5;
            padding-bottom: 70px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* é¡µé¢æ ·å¼ */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-top: 10px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #86868b;
            font-size: 16px;
        }
        
        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            position: relative;
            flex: 1;
            max-width: 500px;
        }
        
        #search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 16px;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        #search-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #86868b;
            font-size: 18px;
        }
        
        .view-toggle {
            display: flex;
            gap: 8px;
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            padding: 4px;
        }
        
        .view-btn {
            background: transparent;
            border: none;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
        }
        
        .view-btn.active {
            background-color: #007aff;
            color: white;
        }
        
        .view-btn:hover {
            background-color: #f5f5f7;
        }
        
        .view-btn.active:hover {
            background-color: #007aff;
        }
        
        /* å…¬å‘Šæ æ ·å¼ */
        .announcement-bar {
            background-color: #f5f5f7;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 25px;
            border-left: 4px solid #007aff;
        }
        
        .announcement-bar p {
            color: #515154;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* åº”ç”¨åˆ—è¡¨å®¹å™¨ */
        .apps-container {
            margin-bottom: 30px;
        }
        
        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            padding: 5px;
        }
        
        .app-list {
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        
        /* ä¿®å¤è§†å›¾åˆ‡æ¢ï¼šæ·»åŠ æ˜ç¡®çš„æ˜¾ç¤º/éšè—æ§åˆ¶ */
        .app-grid:not(.active) {
            display: none;
        }
        
        .app-list:not(.active) {
            display: none;
        }
        
        .app-grid.active {
            display: grid;
        }
        
        .app-list.active {
            display: flex;
        }
        
        /* åº”ç”¨å¡ç‰‡æ ·å¼ */
        .app-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            height: 100%;
            border: 1px solid transparent;
        }
        
        .app-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: #007aff;
        }
        
        .app-icon {
            width: 90px;
            height: 90px;
            border-radius: 22px;
            object-fit: cover;
            margin-bottom: 15px;
            background-color: #f5f5f7;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .app-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 42px;
        }
        
        .app-meta {
            color: #86868b;
            font-size: 13px;
            margin-top: auto;
            width: 100%;
        }
        
        /* åˆ—è¡¨è§†å›¾æ ·å¼ */
        .app-list-item {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            gap: 20px;
            align-items: center;
            border: 1px solid transparent;
        }
        
        .app-list-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: #007aff;
        }
        
        .app-list-item .app-icon {
            width: 70px;
            height: 70px;
            margin-bottom: 0;
        }
        
        .app-list-item .app-info {
            flex: 1;
            text-align: left;
            min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .app-list-item .app-name {
            font-size: 18px;
            margin-bottom: 6px;
            height: auto;
        }
        
        .app-list-item .app-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .app-list-item .app-description {
            color: #515154;
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .page-btn {
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .page-btn:hover:not(:disabled) {
            background-color: #f5f5f7;
            border-color: #86868b;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s ease;
        }
        
        .page-number:hover:not(.active) {
            background-color: #f5f5f7;
        }
        
        .page-number.active {
            background-color: #007aff;
            color: white;
        }
        
        /* åº”ç”¨è¯¦æƒ…å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            padding: 30px;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 28px;
            cursor: pointer;
            color: #86868b;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .modal-close:hover {
            background-color: #f5f5f7;
        }
        
        .detail-section {
            margin-bottom: 25px;
        }
        
        .detail-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1d1d1f;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            text-align: center;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn-primary {
            background-color: #007aff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056cc;
        }
        
        .btn-secondary {
            background-color: #f2f2f7;
            color: #1d1d1f;
        }
        
        .btn-secondary:hover {
            background-color: #e5e5ea;
        }
        
        .btn-success {
            background-color: #34c759;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2aa44f;
        }
        
        .btn-danger {
            background-color: #ff3b30;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d70015;
        }
        
        /* åº•éƒ¨å¯¼èˆªæ  */
        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid #d2d2d7;
            z-index: 100;
            padding: 10px 0;
        }
        
        .nav-list {
            display: flex;
            justify-content: space-around;
            list-style: none;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #86868b;
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .nav-link.active {
            color: #007aff;
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        .nav-link span:last-child {
            font-size: 12px;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background-color: #f5f5f7;
        }
        
        /* æç¤ºæ¶ˆæ¯æ ·å¼ */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            min-width: 250px;
            max-width: 350px;
            font-size: 15px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid #007aff;
        }
        
        .toast.success {
            border-left-color: #34c759;
        }
        
        .toast.error {
            border-left-color: #ff3b30;
        }
        
        .toast.warning {
            border-left-color: #ff9500;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* æˆ‘çš„é¡µé¢æ ·å¼ */
        .user-header {
            text-align: center;
            padding: 30px 20px 20px;
            background: linear-gradient(135deg, #007aff, #5856d6);
            border-radius: 20px;
            color: white;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 122, 255, 0.2);
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 15px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .user-header h3 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .auth-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .auth-buttons .btn {
            min-width: 120px;
        }
        
        /* ç”¨æˆ·åŠŸèƒ½åˆ—è¡¨ */
        .feature-list {
            list-style: none;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #f2f2f7;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .feature-item:last-child {
            border-bottom: none;
        }
        
        .feature-item:hover {
            background-color: #f9f9fb;
        }
        
        .feature-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }
        
        .feature-item span:last-child {
            font-size: 17px;
            font-weight: 500;
            color: #1d1d1f;
        }
        
        /* ä¸Šä¼ é¡µé¢æ ·å¼ */
        .upload-form {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .upload-form h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 30px;
            color: #1d1d1f;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1d1d1f;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 16px;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .help-text {
            font-size: 13px;
            color: #86868b;
            margin-top: 6px;
        }
        
        .upload-preview {
            text-align: center;
            padding: 20px;
            border: 2px dashed #d2d2d7;
            border-radius: 12px;
            margin-bottom: 25px;
            background-color: #f9f9fb;
        }
        
        .upload-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .upload-preview p {
            color: #86868b;
            font-size: 14px;
            margin-top: 10px;
        }
        
        /* è®¤è¯å¯¹è¯æ¡†æ ·å¼ */
        .dialog-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        
        .auth-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            z-index: 10000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .auth-dialog h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
            color: #1d1d1f;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .auth-form input {
            padding: 14px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 16px;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        .auth-form input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .auth-form .btn {
            margin-top: 10px;
        }
        
        .forgot-password {
            text-align: right;
            margin-top: -10px;
        }
        
        .forgot-password a {
            color: #007aff;
            text-decoration: none;
            font-size: 14px;
        }
        
        .forgot-password a:hover {
            text-decoration: underline;
        }
        
        .password-hint {
            font-size: 12px;
            color: #86868b;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .app-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .app-card {
                padding: 18px;
            }
            
            .app-icon {
                width: 80px;
                height: 80px;
            }
            
            .app-name {
                font-size: 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .container {
                padding: 10px;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .app-list-item {
                padding: 18px;
                gap: 15px;
            }
            
            .app-list-item .app-icon {
                width: 60px;
                height: 60px;
            }
            
            .app-list-item .app-meta {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .auth-dialog {
                padding: 30px 20px;
                width: 95%;
            }
            
            .upload-form {
                padding: 20px;
            }
            
            .user-header {
                padding: 25px 15px 15px;
            }
        }
        
        @media (max-width: 480px) {
            .app-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                max-width: 100%;
            }
            
            .view-toggle {
                align-self: flex-end;
            }
            
            .app-list-item {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .app-list-item .app-info {
                text-align: center;
            }
            
            .app-list-item .app-meta {
                justify-content: center;
            }
            
            .auth-buttons {
                flex-direction: column;
            }
            
            .auth-buttons .btn {
                width: 100%;
            }
        }
        
        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }
        
        .empty-state p {
            font-size: 16px;
            margin-top: 15px;
        }
        
        /* æœç´¢ç»Ÿè®¡ */
        .search-stats {
            margin-bottom: 20px;
            color: #515154;
            font-size: 14px;
            text-align: center;
        }
        
        /* æ›´æ–°æ—¥æœŸ */
        .update-time {
            text-align: center;
            font-size: 12px;
            color: #86868b;
            margin-top: 8px;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’® */
        .file-upload-btn {
            display: inline-block;
            background-color: #f2f2f7;
            border: 2px dashed #d2d2d7;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .file-upload-btn:hover {
            background-color: #e5e5ea;
            border-color: #007aff;
        }
        
        .file-upload-btn span {
            color: #007aff;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¦–é¡µ -->
        <div class="page active" id="home-page">
            <header class="header">
                <h1>ç¦¾èŠ’æ–°å±¿è¡¨ç›˜å•†åº—</h1>
                <p>å‘ç°ç²¾å½©è¡¨ç›˜ï¼Œä¸ªæ€§åŒ–ä½ çš„è®¾å¤‡</p>
            </header>

            <!-- æœç´¢å’Œè§†å›¾åˆ‡æ¢å·¥å…·æ  -->
            <div class="toolbar">
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="æœç´¢è¡¨ç›˜åç§°ã€ä½œè€…æˆ–æè¿°...">
                    <span class="search-icon">ğŸ”</span>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="grid" title="æ–¹æ ¼è§†å›¾">
                        <span>ğŸ—</span>
                    </button>
                    <button class="view-btn" data-view="list" title="åˆ—è¡¨è§†å›¾">
                        <span>ğŸ“‘</span>
                    </button>
                </div>
            </div>

            <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
            <div class="search-stats" id="search-stats">
                æ­£åœ¨åŠ è½½è¡¨ç›˜æ•°æ®...
            </div>

            <!-- åº”ç”¨åˆ—è¡¨å®¹å™¨ -->
            <div class="apps-container">
                <div class="app-grid active" id="app-grid-view">
                    <!-- æ–¹æ ¼è§†å›¾å†…å®¹ -->
                </div>
                <div class="app-list" id="app-list-view">
                    <!-- åˆ—è¡¨è§†å›¾å†…å®¹ -->
                </div>
            </div>

            <!-- åˆ†é¡µæ§ä»¶ -->
            <div class="pagination" id="pagination">
                <button class="page-btn" id="prev-page">ä¸Šä¸€é¡µ</button>
                <div class="page-numbers" id="page-numbers"></div>
                <button class="page-btn" id="next-page">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
        
        <!-- æˆ‘çš„é¡µé¢ -->
        <div class="page" id="profile-page">
            <div class="user-header">
                <div class="user-avatar">ğŸ‘¤</div>
                <h3 id="user-name">æˆ‘çš„ç©ºé—´</h3>
                <div id="auth-buttons" class="auth-buttons">
                    <button class="btn btn-primary" id="signup-btn">æ³¨å†Œ</button>
                    <button class="btn btn-secondary" id="login-btn">ç™»å½•</button>
                    <button class="btn btn-danger" id="logout-btn" style="display:none;">é€€å‡ºç™»å½•</button>
                </div>
            </div>
            
            <div id="user-features">
                <ul class="feature-list">
                    <li class="feature-item" id="upload-feature">
                        <span class="feature-icon">ğŸ“¤</span>
                        <span>ä¸Šä¼ è¡¨ç›˜æ–‡ä»¶</span>
                    </li>
                    <li class="feature-item" id="my-apps-feature">
                        <span class="feature-icon">ğŸ“±</span>
                        <span>æˆ‘çš„è¡¨ç›˜</span>
                    </li>
                </ul>
                
                <!-- è”ç³»æŒ‰é’® -->
                <ul class="feature-list" style="margin-top: 30px; padding-bottom: 100px;">
                    <li class="feature-item" style="justify-content: center; cursor: pointer;">
                        <a href="https://qm.qq.com/q/MkzRaG2YoM" class="btn btn-primary" target="_blank" style="margin: 0; width: auto; display: inline-flex; align-items: center; justify-content: center;">
                            <span style="margin-right: 8px;">ğŸ‘¨â€ğŸ’»</span>ç‚¹å‡»é“¾æ¥åŠ å…¥ç¾¤èŠã€ã€Blue OSã€‘å‘çƒ§å‹èšé›†åœ°ã€‘
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- ä¸Šä¼ é¡µé¢ -->
        <div class="page" id="upload-page">
            <div class="upload-form">
                <h2>ä¸Šä¼ è¡¨ç›˜æ–‡ä»¶</h2>
                <div class="form-group">
                    <label for="app-file">é€‰æ‹©.rpkæ–‡ä»¶ï¼ˆé€‰æ‹©åè‡ªåŠ¨å¡«å……ä»¥ä¸‹ä¿¡æ¯ï¼‰</label>
                    <div class="file-upload-btn" onclick="document.getElementById('app-file').click()">
                        <span>ç‚¹å‡»é€‰æ‹©.rpkæ–‡ä»¶</span>
                    </div>
                    <input type="file" id="app-file" accept=".rpk" multiple="false" style="display: none;">
                </div>
                <div class="form-group">
                    <label for="app-name">è¡¨ç›˜åç§°</label>
                    <input type="text" id="app-name" placeholder="è¯·è¾“å…¥è¡¨ç›˜åç§°">
                </div>
                <div class="form-group">
                    <label for="app-package">åŒ…å (å¦‚: com.example.watchface)</label>
                    <input type="text" id="app-package" placeholder="è¯·è¾“å…¥åŒ…å">
                </div>
                <div class="form-group">
                    <label for="app-version">ç‰ˆæœ¬å· (å¦‚: 1.0.0)</label>
                    <input type="text" id="app-version" placeholder="è¯·è¾“å…¥ç‰ˆæœ¬å·">
                </div>
                <div class="form-group">
                    <label for="app-description">è¡¨ç›˜æè¿°</label>
                    <textarea id="app-description" placeholder="è¯·è¾“å…¥è¡¨ç›˜æè¿°"></textarea>
                </div>
                <div class="form-group">
                    <label for="app-author">è¡¨ç›˜ä½œè€…</label>
                    <input type="text" id="app-author" placeholder="è¯·è¾“å…¥è¡¨ç›˜ä½œè€…åç§°">
                </div>
                <div class="form-group">
                    <label for="app-icon">è‡ªå®šä¹‰å›¾æ ‡ (å¯é€‰)</label>
                    <div class="file-upload-btn" onclick="document.getElementById('app-icon').click()">
                        <span>ç‚¹å‡»é€‰æ‹©å›¾æ ‡æ–‡ä»¶ (PNG/JPG)</span>
                    </div>
                    <input type="file" id="app-icon" accept=".png,.jpg,.jpeg" multiple="false" style="display: none;">
                    <p class="help-text">ä¸Šä¼ PNGæˆ–JPGæ ¼å¼çš„å›¾ç‰‡ä½œä¸ºè¡¨ç›˜å›¾æ ‡ï¼Œè‹¥ä¸é€‰æ‹©å°†ä½¿ç”¨åŒ…å†…å›¾æ ‡</p>
                </div>
                <div class="upload-preview" id="upload-preview">
                    <p>è¡¨ç›˜é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                </div>
                <button class="btn btn-primary" id="submit-upload" style="width: 100%; padding: 16px; font-size: 17px;">æäº¤ä¸Šä¼ </button>
            </div>
        </div>
        
        <!-- æˆ‘çš„è¡¨ç›˜é¡µé¢ -->
        <div class="page" id="my-apps-page">
            <header class="header">
                <h1>æˆ‘çš„è¡¨ç›˜</h1>
                <p>æŸ¥çœ‹å’Œç®¡ç†æ‚¨ä¸Šä¼ çš„è¡¨ç›˜</p>
            </header>
            
            <div class="app-grid" id="my-apps-list">
                <!-- æˆ‘çš„è¡¨ç›˜åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="footer-nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="#home" class="nav-link active" data-page="home-page">
                    <span class="nav-icon">ğŸ—</span>
                    <span>é¦–é¡µ</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="https://qm.qq.com/q/MkzRaG2YoM" class="nav-link" target="_blank">
                    <span class="nav-icon">ğŸ‘¨â€ğŸ’»</span>
                    <span>åŠ å…¥ç¾¤èŠ</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#profile" class="nav-link" data-page="profile-page">
                    <span class="nav-icon">ğŸ‘¤</span>
                    <span>æˆ‘çš„</span>
                </a>
            </li>
        </ul>
        <!-- æœ€åæ›´æ–°æ—¶é—´ -->
        <div class="update-time">
            <p>æœ€åæ›´æ–°æ—¶é—´: <span id="current-date"></span></p>
        </div>
    </nav>

    <!-- åº”ç”¨è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="detail-modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- å…¨å±€æç¤ºå®¹å™¨ -->
    <div id="toast-container"></div>

    <!-- è®¤è¯å¯¹è¯æ¡†èƒŒæ™¯ -->
    <div class="dialog-backdrop" id="auth-backdrop"></div>

    <!-- ç™»å½•å¯¹è¯æ¡† -->
    <div class="auth-dialog" id="login-dialog">
        <h3>ç™»å½•</h3>
        <form class="auth-form" id="login-form">
            <input type="email" id="login-email" placeholder="é‚®ç®±" required>
            <input type="password" id="login-password" placeholder="å¯†ç " required>
            <div class="forgot-password">
                <a href="#" id="forgot-password-link">å¿˜è®°å¯†ç ?</a>
            </div>
            <button type="submit" class="btn btn-primary">ç™»å½•</button>
        </form>
    </div>

    <!-- æ³¨å†Œå¯¹è¯æ¡† -->
    <div class="auth-dialog" id="signup-dialog">
        <h3>æ³¨å†Œ</h3>
        <form class="auth-form" id="signup-form">
            <input type="email" id="signup-email" placeholder="é‚®ç®±" required>
            <input type="password" id="signup-password" placeholder="å¯†ç " required>
            <div class="password-hint">
                å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼Œè‡³å°‘8ä¸ªå­—ç¬¦
            </div>
            <input type="password" id="signup-password-confirm" placeholder="ç¡®è®¤å¯†ç " required>
            <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
        </form>
    </div>

    <!-- é‡ç½®å¯†ç å¯¹è¯æ¡† -->
    <div class="auth-dialog" id="reset-password-dialog">
        <h3>é‡ç½®å¯†ç </h3>
        <form class="auth-form" id="reset-password-form">
            <input type="email" id="reset-email" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±" required>
            <button type="submit" class="btn btn-primary">å‘é€é‡ç½®é“¾æ¥</button>
        </form>
    </div>

    <script>
    // è®¾ç½®å½“å‰æ—¥æœŸ
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // Supabase é…ç½®
    const SUPABASE = {
        URL: 'https://ogpznrnpldszxxwizfbp.supabase.co',
        KEY: 'sb_publishable_BG-NEUkCoOI08WOITCA9ZQ_W53WeSx3',
        STORAGE_BUCKET: 'applications'
    };

    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const { createClient } = window.supabase;
    const supabaseClient = createClient(SUPABASE.URL, SUPABASE.KEY);

    // çŠ¶æ€ç®¡ç†
    let appsData = [];
    let myApps = [];
    let currentUser = null;
    
    // åˆ†é¡µå’Œæœç´¢çŠ¶æ€
    let currentView = 'grid'; // 'grid' æˆ– 'list'
    let currentPage = 1;
    let itemsPerPage = 24;
    let filteredApps = [];
    let searchTimeout = null;

    // é…ç½®
    const CONFIG = {
        defaultIcon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIHJ4PSIyMCIgZmlsbD0iI2Y1ZjVmNyIvPjxwYXRoIGQ9Ik00MCAzMUM0NS41MjI4IDMxIDUwIDM1LjQ3NzIgNTAgNDFDNTAgNDYuNTIyOCA0NS41MjI4IDUxIDQwIDUxQzM0LjQ3NzIgNTEgMzAgNDYuNTIyOCAzMCA0MUMzMCAzNS40NzcyIDM0LjQ3NzIgMzEgNDAgMzFaTTQ3IDM2LjVDNDcgMzUuNjcxNiA0Ni4zMjg4IDM1IDQ1LjUgMzVDNDQuNjcxMiAzNSA0NCAzNS42NzE2IDQ0IDM2LjVDNDQgMzcuMzI4NCA0NC42NzEyIDM4IDQ1LjUgMzhDNDYuMzI4OCAzOCA0NyAzNy4zMjg0IDQ3IDM2LjVaTTMzIDM2LjVDMzMgMzUuNjcxNiAzMi4zMjg4IDM1IDMxLjUgMzVDMzAuNjcxMiAzNSAzMCAzNS42NzE2IDMwIDM2LjVDMzAgMzcuMzI4NCAzMC42NzEyIDM4IDMxLjUgMzhDMzIuMzI4OCAzOCAzMyAzNy4zMjg0IDMzIDM2LjVaTTM1LjUgNTFDMzUuNSA1MS44Mjg0IDM2LjE3MTYgNTIuNSAzNyA1Mi41SDQzQzQzLjgyODQgNTIuNSA0NC41IDUxLjgyODQgNDQuNSA1MUM0NC41IDUwLjE3MTYgNDMuODI4NCA0OS41IDQzIDQ5LjVIMzdDMzYuMTcxNiA0OS41IDM1LjUgNTAuMTcxNiAzNS41IDUxWiIgZmlsbD0iI2I4YjhiOCIvPjwvc3ZnPg=='
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
        initializeEventListeners();
        
        // æ£€æŸ¥ç°æœ‰ä¼šè¯
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) {
            currentUser = session.user;
            updateUIForLoggedInUser(currentUser);
            await loadMyApps();
        }
        
        await initData();
    });

    // éªŒè¯å¯†ç å¼ºåº¦
    function validatePassword(password) {
        const hasLower = /[a-z]/.test(password);
        const hasUpper = /[A-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        
        if (!hasLower || !hasUpper || !hasNumber || password.length < 8) {
            return false;
        }
        return true;
    }

    // ç”¨æˆ·ç™»å½•
    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) throw error;
            
            currentUser = data.user;
            updateUIForLoggedInUser(currentUser);
            hideDialogs();
            showToast('ç™»å½•æˆåŠŸ!', 'success');
            
            // åŠ è½½ç”¨æˆ·æ•°æ®
            await loadMyApps();
        } catch (error) {
            showToast('ç™»å½•å¤±è´¥: ' + error.message, 'error');
        }
    }

    // ç”¨æˆ·æ³¨å†Œ
    async function handleSignup(e) {
        e.preventDefault();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-password-confirm').value;
        
        if (!validatePassword(password)) {
            showToast('å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼Œä¸”è‡³å°‘8ä¸ªå­—ç¬¦', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
            return;
        }
        
        try {
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: `${window.location.origin}/auth-callback`
                }
            });
            
            if (error) throw error;
            
            hideDialogs();
            showToast('æ³¨å†ŒæˆåŠŸ!è¯·æŸ¥æ”¶éªŒè¯é‚®ä»¶', 'success');
        } catch (error) {
            showToast('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
        }
    }

    // è¯·æ±‚é‡ç½®å¯†ç 
    async function handlePasswordReset(e) {
        e.preventDefault();
        const email = document.getElementById('reset-email').value;
        
        try {
            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: `${window.location.origin}/reset-password`
            });
            
            if (error) throw error;
            
            hideDialogs();
            showToast('é‡ç½®å¯†ç é“¾æ¥å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±', 'success');
        } catch (error) {
            showToast('å‘é€é‡ç½®é“¾æ¥å¤±è´¥: ' + error.message, 'error');
        }
    }

    // ç”¨æˆ·ç™»å‡º
    async function handleLogout() {
        try {
            const { error } = await supabaseClient.auth.signOut();
            if (error) throw error;
            
            currentUser = null;
            document.getElementById('login-btn').style.display = 'block';
            document.getElementById('signup-btn').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'none';
            document.querySelector('.user-avatar').textContent = 'ğŸ‘¤';
            document.getElementById('user-name').textContent = 'æˆ‘çš„ç©ºé—´';
            
            showToast('å·²é€€å‡ºç™»å½•', 'success');
            showPage('home-page');
        } catch (error) {
            showToast('é€€å‡ºå¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ›´æ–°å·²ç™»å½•ç”¨æˆ·çš„UI
    function updateUIForLoggedInUser(user) {
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('signup-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'block';
        document.querySelector('.user-avatar').textContent = user.email[0].toUpperCase();
        document.getElementById('user-name').textContent = user.email;
    }

    // åˆå§‹åŒ–æ•°æ®
    async function initData() {
        try {
            // æ›´æ–°æœç´¢ç»Ÿè®¡
            document.getElementById('search-stats').textContent = 'æ­£åœ¨åŠ è½½è¡¨ç›˜æ•°æ®...';
            
            // è·å–åº”ç”¨åˆ—è¡¨
            const { data: apps, error: appErr } = await supabaseClient
                .from('applications')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (appErr) throw appErr;
            
            // è¿‡æ»¤è¡¨ç›˜åº”ç”¨ï¼ˆåç§°ä¸­åŒ…å«"è¡¨ç›˜"çš„åº”ç”¨ï¼‰
            appsData = (apps || []).filter(app => 
                app.name && (app.name.includes('è¡¨ç›˜') || app.name.includes('è¡¨ç›˜') || 
                (app.description && app.description.includes('è¡¨ç›˜')))
            );
            
            filteredApps = [...appsData];
            
            // æ›´æ–°æœç´¢ç»Ÿè®¡
            updateSearchStats();
            
            // åˆå§‹åŒ–è§†å›¾å’Œåˆ†é¡µ
            setupSearchAndPagination();
            
        } catch (error) {
            showToast('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message, 'error');
            document.getElementById('search-stats').textContent = 'æ•°æ®åŠ è½½å¤±è´¥';
            console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        }
    }

    // æ›´æ–°æœç´¢ç»Ÿè®¡
    function updateSearchStats() {
        const searchStats = document.getElementById('search-stats');
        const searchInput = document.getElementById('search-input');
        const searchTerm = searchInput ? searchInput.value.trim() : '';
        
        if (searchTerm) {
            searchStats.textContent = `æ‰¾åˆ° ${filteredApps.length} ä¸ªä¸"${searchTerm}"ç›¸å…³çš„è¡¨ç›˜`;
        } else {
            searchStats.textContent = `å…± ${filteredApps.length} ä¸ªè¡¨ç›˜`;
        }
        
        // å¦‚æœæ²¡æœ‰æœç´¢ç»“æœ
        if (filteredApps.length === 0 && searchTerm) {
            searchStats.innerHTML = `æ²¡æœ‰æ‰¾åˆ°ä¸"${searchTerm}"ç›¸å…³çš„è¡¨ç›˜ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯`;
        }
    }

    // è®¾ç½®æœç´¢å’Œåˆ†é¡µåŠŸèƒ½
    function setupSearchAndPagination() {
        // æœç´¢åŠŸèƒ½ - ä½¿ç”¨é˜²æŠ–å‡å°‘é¢‘ç¹æœç´¢
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim();
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œå»¶è¿Ÿ300msæ‰§è¡Œæœç´¢
                searchTimeout = setTimeout(() => {
                    filterApps(searchTerm);
                    currentPage = 1;
                    renderApps();
                    updateSearchStats();
                }, 300);
            });
        }
        
        // è§†å›¾åˆ‡æ¢
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentView = this.dataset.view;
                switchView(currentView);
            });
        });
        
        // åˆ†é¡µæŒ‰é’®
        document.getElementById('prev-page')?.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderApps();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
        
        document.getElementById('next-page')?.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredApps.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderApps();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
        
        // åˆå§‹æ¸²æŸ“
        renderApps();
    }

    // è¿‡æ»¤åº”ç”¨
    function filterApps(searchTerm) {
        if (!searchTerm) {
            filteredApps = [...appsData];
        } else {
            const lowerSearchTerm = searchTerm.toLowerCase();
            filteredApps = appsData.filter(app => {
                // æœç´¢åç§°
                if (app.name && app.name.toLowerCase().includes(lowerSearchTerm)) return true;
                
                // æœç´¢æè¿°
                if (app.description && app.description.toLowerCase().includes(lowerSearchTerm)) return true;
                
                // æœç´¢åŒ…å
                if (app.package && app.package.toLowerCase().includes(lowerSearchTerm)) return true;
                
                // æœç´¢ä½œè€…
                if (app.author_name && app.author_name.toLowerCase().includes(lowerSearchTerm)) return true;
                
                return false;
            });
        }
    }

    // åˆ‡æ¢è§†å›¾
    function switchView(view) {
        const gridView = document.getElementById('app-grid-view');
        const listView = document.getElementById('app-list-view');
        
        if (view === 'grid') {
            gridView.classList.add('active');
            listView.classList.remove('active');
        } else {
            gridView.classList.remove('active');
            listView.classList.add('active');
        }
        
        // é‡æ–°æ¸²æŸ“åº”ç”¨ï¼ˆä¿æŒå½“å‰åˆ†é¡µï¼‰
        renderApps();
    }

    // ä¸Šä¼ åº”ç”¨åˆ° Supabase
    async function saveApplication(appData, file) {
        if (!currentUser) {
            showToast('è¯·å…ˆç™»å½•', 'error');
            return;
        }
        
        let filePath = null;

        try {
            showToast('å¼€å§‹ä¸Šä¼ è¡¨ç›˜...', 'info');
            
            // è·å–ä½œè€…ä¿¡æ¯
            const authorName = appData.author_name || currentUser.email;
            
            // ä¸Šä¼ æ–‡ä»¶
            const timestamp = Date.now();
            const fileName = `${appData.package}_${timestamp}.rpk`;
            filePath = `${currentUser.id}/${fileName}`;
            
            // ä¸Šä¼ RPKæ–‡ä»¶
            const { data: fileData, error: uploadError } = await supabaseClient.storage
                .from(SUPABASE.STORAGE_BUCKET)
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (uploadError) {
                console.error('æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', uploadError);
                throw new Error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${uploadError.message}`);
            }
            
            // è·å–å…¬å¼€URL
            const { data: urlData } = supabaseClient.storage
                .from(SUPABASE.STORAGE_BUCKET)
                .getPublicUrl(filePath);

            // å‡†å¤‡æ’å…¥çš„æ•°æ®
            const appDataToInsert = {
                name: appData.name,
                package: appData.package,
                version: appData.version,
                description: appData.description,
                download_url: urlData.publicUrl,
                icon_url: appData.icon,
                author_name: authorName,
                author: currentUser.id,
                created_at: new Date().toISOString(),
                is_anonymous: false
            };
            
            const { data: insertData, error: dbError } = await supabaseClient
                .from('applications')
                .insert(appDataToInsert)
                .select();
            
            if (dbError) {
                console.error('æ•°æ®åº“æ’å…¥é”™è¯¯:', dbError);
                throw new Error(`æ•°æ®åº“æ’å…¥å¤±è´¥: ${dbError.message}`);
            }
            
            showToast('è¡¨ç›˜ä¸Šä¼ æˆåŠŸ!', 'success');
            await initData();
            await loadMyApps();
            
            // æ¸…ç©ºè¡¨å•
            clearUploadForm();
            
            // è¿”å›é¦–é¡µ
            showPage('home-page');
            
        } catch (error) {
            console.error('å®Œæ•´ä¸Šä¼ é”™è¯¯:', error);
            showToast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            
            // æ¸…ç†å·²ä¸Šä¼ çš„æ–‡ä»¶
            if (filePath && currentUser) {
                try {
                    const { error: removeError } = await supabaseClient.storage
                        .from(SUPABASE.STORAGE_BUCKET)
                        .remove([filePath]);
                    
                    if (removeError) {
                        console.error('æ¸…ç†å·²ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', removeError);
                    }
                } catch (cleanupError) {
                    console.error('æ¸…ç†æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:', cleanupError);
                }
            }
        }
    }

    // æ¸…ç©ºä¸Šä¼ è¡¨å•
    function clearUploadForm() {
        document.getElementById('app-file').value = '';
        document.getElementById('app-name').value = '';
        document.getElementById('app-package').value = '';
        document.getElementById('app-version').value = '';
        document.getElementById('app-description').value = '';
        document.getElementById('app-author').value = '';
        document.getElementById('app-icon').value = '';
        document.getElementById('upload-preview').innerHTML = '<p>è¡¨ç›˜é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>';
    }

    // å¤„ç†æ‰‹åŠ¨ä¸Šä¼ 
    async function handleManualUpload() {
        if (!currentUser) {
            showToast('è¯·å…ˆç™»å½•', 'error');
            return;
        }
        
        try {
            const fileInput = document.getElementById('app-file');
            const files = fileInput.files;
            const iconInput = document.getElementById('app-icon');
            const iconFile = iconInput.files[0];

            if (files.length === 0) {
                showToast('è¯·é€‰æ‹©.rpkæ–‡ä»¶', 'error');
                return;
            }
            if (files.length > 1) {
                showToast('æ¯æ¬¡åªèƒ½ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶', 'error');
                fileInput.value = '';
                return;
            }

            const file = files[0];
            const packageName = document.getElementById('app-package').value.trim();

            // æ£€æŸ¥åŒ…åæ˜¯å¦å·²å­˜åœ¨
            const { data: existingApps, error: queryError } = await supabaseClient
                .from('applications')
                .select('package')
                .eq('package', packageName);
                
            if (queryError) throw queryError;
            
            if (existingApps && existingApps.length > 0) {
                showToast('è¯¥è¡¨ç›˜å·²å­˜åœ¨,è¯·ä½¿ç”¨å…¶ä»–åŒ…å', 'error');
                return;
            }

            const name = document.getElementById('app-name').value.trim();
            const version = document.getElementById('app-version').value.trim();
            const description = document.getElementById('app-description').value.trim();
            const author = document.getElementById('app-author').value.trim();

            if (!name || !packageName || !version) throw new Error('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
            if (!file) throw new Error('è¯·é€‰æ‹©.rpkæ–‡ä»¶');

            // è§£æRPKæ–‡ä»¶è·å–æ›´å¤šä¿¡æ¯
            const appInfo = await parseRPK(file);
            if (!appInfo) throw new Error('æ— æ³•è§£æè¡¨ç›˜ä¿¡æ¯');

            // å¦‚æœç”¨æˆ·é€‰æ‹©äº†è‡ªå®šä¹‰å›¾æ ‡ï¼Œä½¿ç”¨å®ƒ
            if (iconFile) {
                const iconBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(iconFile);
                });
                appInfo.icon = iconBase64;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºè¡¨ç›˜åº”ç”¨
            let finalName = name;
            if (appInfo.isWatchface && !finalName.includes('ï¼ˆè¡¨ç›˜ï¼‰') && !finalName.includes('(è¡¨ç›˜)')) {
                finalName = `${finalName} (è¡¨ç›˜)`;
            }
            
            // åˆå¹¶è¡¨å•æ•°æ®å’Œè§£ææ•°æ®
            const newApp = {
                ...appInfo,
                name: finalName,
                package: packageName,
                version: version,
                description: description,
                author_name: author || currentUser.email
            };

            await saveApplication(newApp, file);
        } catch (error) {
            showToast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
        }
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©(ç”¨äºä¸Šä¼ )
    async function handleFileSelectForUpload(e) {
        try {
            const files = e.target.files;
            if (files.length > 1) {
                showToast('æ¯æ¬¡åªèƒ½ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶', 'error');
                e.target.value = ''; // æ¸…ç©ºå·²é€‰æ–‡ä»¶
                return;
            }

            const file = files[0];
            if (!file) return;

            if (!validateFile(file)) {
                e.target.value = ''; // æ¸…ç©ºæ— æ•ˆæ–‡ä»¶
                return;
            }

            const preview = document.getElementById('upload-preview');
            preview.innerHTML = '';

            const appInfo = await parseRPK(file);
            if (appInfo) {
                // è‡ªåŠ¨å¡«å……è¡¨å•
                document.getElementById('app-name').value = appInfo.name;
                document.getElementById('app-package').value = appInfo.package;
                document.getElementById('app-version').value = appInfo.version;
                document.getElementById('app-description').value = appInfo.description || '';

                // æ˜¾ç¤ºé¢„è§ˆ
                const img = document.createElement('img');
                img.src = appInfo.icon;
                preview.appendChild(img);

                showToast('è¡¨ç›˜ä¿¡æ¯å·²è‡ªåŠ¨å¡«å……');
            }
        } catch (error) {
            showToast('é€‰æ‹©æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message, 'error');
            console.error('æ–‡ä»¶é€‰æ‹©é”™è¯¯:', error);
            e.target.value = ''; // æ¸…ç©ºå‡ºé”™æ–‡ä»¶
        }
    }

    // åŠ è½½æˆ‘çš„åº”ç”¨
    async function loadMyApps() {
        if (!currentUser) {
            myApps = [];
            return;
        }
        
        try {
            // è·å–ç”¨æˆ·ä¸Šä¼ çš„åº”ç”¨
            const { data: apps, error: appsError } = await supabaseClient
                .from('applications')
                .select('*')
                .eq('author', currentUser.id);
            
            if (appsError) throw appsError;
            myApps = apps || [];
            
            // å¦‚æœæ­£åœ¨æˆ‘çš„è¡¨ç›˜é¡µé¢ï¼Œæ›´æ–°æ˜¾ç¤º
            if (document.getElementById('my-apps-page').classList.contains('active')) {
                renderMyApps();
            }
        } catch (error) {
            console.error('åŠ è½½æˆ‘çš„è¡¨ç›˜å¤±è´¥:', error);
        }
    }

    // æ¸²æŸ“æˆ‘çš„åº”ç”¨
    function renderMyApps() {
        const myAppsList = document.getElementById('my-apps-list');
        myAppsList.innerHTML = '';
        
        if (myApps.length === 0) {
            myAppsList.innerHTML = '<div class="empty-state"><p>æ‚¨è¿˜æ²¡æœ‰ä¸Šä¼ è¿‡è¡¨ç›˜</p></div>';
            return;
        }
        
        // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæ‰¹é‡æ·»åŠ DOMå…ƒç´ 
        const fragment = document.createDocumentFragment();
        
        myApps.forEach(app => {
            const card = document.createElement('div');
            card.className = 'app-card';
            card.dataset.id = app.id;
            
            const realSrc = app.icon_url || CONFIG.defaultIcon;
            card.innerHTML = `
                <img class="app-icon" src="${realSrc}" 
                     alt="${app.name}" 
                     onerror="this.src='${CONFIG.defaultIcon}'">
                <h3 class="app-name">${app.name}</h3>
                <div class="app-meta">
                    <p>ç‰ˆæœ¬: ${app.version || '1.0.0'}</p>
                    <p>ä½œè€…: ${app.author_name || 'åŒ¿åç”¨æˆ·'}</p>
                </div>
            `;
            
            card.addEventListener('click', () => showAppDetail(app));
            fragment.appendChild(card);
        });
        
        myAppsList.appendChild(fragment);
    }

    // æ¸²æŸ“åº”ç”¨å¡ç‰‡
    function renderAppCard(app, container = null) {
        if (!container) container = document.getElementById('app-grid-view');
        
        const card = document.createElement('div');
        card.className = 'app-card';
        card.dataset.id = app.id;
        
        // ä½¿ç”¨çœŸå®å›¾æ ‡æˆ–é»˜è®¤å›¾æ ‡
        const realSrc = app.icon_url || CONFIG.defaultIcon;
        card.innerHTML = `
            <img class="app-icon" src="${realSrc}" 
                 alt="${app.name}" 
                 onerror="this.src='${CONFIG.defaultIcon}'">
            <h3 class="app-name">${app.name}</h3>
            <div class="app-meta">
                <p>ç‰ˆæœ¬: ${app.version || '1.0.0'}</p>
                <p>ä½œè€…: ${app.author_name || 'åŒ¿åç”¨æˆ·'}</p>
            </div>
        `;
        
        card.addEventListener('click', () => showAppDetail(app));
        container.appendChild(card);
    }
    
    // æ¸²æŸ“åˆ—è¡¨é¡¹
    function renderAppListItem(app, container) {
        const item = document.createElement('div');
        item.className = 'app-list-item';
        item.dataset.id = app.id;
        
        const realSrc = app.icon_url || CONFIG.defaultIcon;
        item.innerHTML = `
            <img class="app-icon" src="${realSrc}" 
                 alt="${app.name}" 
                 onerror="this.src='${CONFIG.defaultIcon}'">
            <div class="app-info">
                <h3 class="app-name">${app.name}</h3>
                <div class="app-meta">
                    <span>ç‰ˆæœ¬: ${app.version || '1.0.0'}</span>
                    <span>ä½œè€…: ${app.author_name || 'åŒ¿åç”¨æˆ·'}</span>
                    <span>ä¸Šä¼ : ${app.created_at ? new Date(app.created_at).toLocaleDateString('zh-CN') : 'æœªçŸ¥'}</span>
                </div>
                <p class="app-description">${app.description || 'æš‚æ— æè¿°'}</p>
            </div>
        `;
        
        item.addEventListener('click', () => showAppDetail(app));
        container.appendChild(item);
    }

    // æ˜¾ç¤ºåº”ç”¨è¯¦æƒ…
    async function showAppDetail(app) {
        const modal = document.getElementById('detail-modal');
        const modalBody = document.getElementById('modal-body');
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·çš„åº”ç”¨
        const isMyApp = currentUser ? app.author === currentUser.id : false;
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        const formattedDate = app.created_at ? 
            new Date(app.created_at).toLocaleString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'æœªçŸ¥';
        
        modalBody.innerHTML = `
            <div class="detail-section">
                <img src="${app.icon_url || CONFIG.defaultIcon}" 
                     alt="${app.name}" class="app-icon" style="width: 120px; height: 120px; border-radius: 24px; margin: 0 auto 20px; display: block; box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
                <h2>${app.name}</h2>
                <p class="app-meta">ç‰ˆæœ¬: ${app.version || '1.0.0'}</p>
                <p class="app-meta">ä½œè€…: ${app.author_name || 'åŒ¿åç”¨æˆ·'}</p>
                <p style="margin-top: 15px; line-height: 1.6;">${app.description || 'æš‚æ— æè¿°'}</p>
            </div>
            <div class="detail-section">
                <h3 class="detail-title">è¡¨ç›˜ä¿¡æ¯</h3>
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <strong>åŒ…å:</strong> ${app.package || 'æœªæä¾›'}
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <strong>ä¸Šä¼ æ—¶é—´:</strong> ${formattedDate}
                    </div>
                </div>
            </div>
            <div class="detail-section">
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <a href="${app.download_url}" class="btn btn-primary" target="_blank" style="padding: 14px 28px; font-size: 17px; text-decoration: none; min-width: 150px; display: inline-flex; align-items: center; justify-content: center;">ç«‹å³ä¸‹è½½</a>
                    ${isMyApp ? `<button class="btn btn-danger" onclick="deleteApp('${app.id}')" style="padding: 14px 28px; font-size: 17px; min-width: 150px; display: inline-flex; align-items: center; justify-content: center;">åˆ é™¤è¡¨ç›˜</button>` : ''}
                </div>
            </div>`;
        
        // æ·»åŠ activeç±»ä»¥è§¦å‘åŠ¨ç”»
        modal.classList.add('active');
        
        // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
        document.querySelector('.modal-close').onclick = closeModal;
    }
    
    // åˆ é™¤åº”ç”¨
    async function deleteApp(appId) {
        if (!currentUser) {
            showToast('åˆ é™¤è¡¨ç›˜éœ€è¦ç™»å½•', 'error');
            return;
        }
        
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡¨ç›˜å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) return;
        
        try {
            // è·å–åº”ç”¨ä¿¡æ¯
            const { data: app, error: fetchError } = await supabaseClient
                .from('applications')
                .select('*')
                .eq('id', appId)
                .single();
                
            if (fetchError) throw fetchError;
            
            // ç¡®ä¿æ˜¯åº”ç”¨æ‰€æœ‰è€…
            if (app.author !== currentUser.id) {
                throw new Error('æ‚¨æ²¡æœ‰æƒé™åˆ é™¤æ­¤è¡¨ç›˜');
            }

            // ä»URLä¸­æå–å­˜å‚¨è·¯å¾„
            const fileUrl = new URL(app.download_url);
            const filePath = `${currentUser.id}/${fileUrl.pathname.split('/').pop()}`;
            
            // åˆ é™¤å­˜å‚¨æ–‡ä»¶
            const { error: storageError } = await supabaseClient.storage
                .from(SUPABASE.STORAGE_BUCKET)
                .remove([filePath]);
            
            if (storageError) {
                console.error('å­˜å‚¨æ–‡ä»¶åˆ é™¤å¤±è´¥:', storageError);
                // ç»§ç»­æ‰§è¡Œï¼Œä¸é˜»æ­¢æ•°æ®åº“è®°å½•çš„åˆ é™¤
            }
            
            // åˆ é™¤æ•°æ®åº“è®°å½•
            const { error: dbError } = await supabaseClient
                .from('applications')
                .delete()
                .match({ id: appId, author: currentUser.id });
                
            if (dbError) throw dbError;
            
            showToast('è¡¨ç›˜å·²åˆ é™¤', 'success');
            closeModal();
            await initData();
            await loadMyApps();
        } catch (error) {
            showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            console.error('åˆ é™¤é”™è¯¯:', error);
        }
    }
    
    // é¡µé¢åˆ‡æ¢
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        
        const page = document.getElementById(pageId);
        if (page) page.classList.add('active');
        
        // åº•éƒ¨å¯¼èˆªæ é«˜äº®
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.dataset.page === pageId) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
        
        // ç‰¹æ®Šé¡µé¢å¤„ç†
        if (pageId === 'my-apps-page') renderMyApps();
        
        // å½“åˆ‡æ¢åˆ°é¦–é¡µæ—¶ï¼Œç¡®ä¿æœç´¢å’Œåˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ
        if (pageId === 'home-page') {
            setupSearchAndPagination();
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ä¸Šä¼ é¡µé¢
        if (pageId === 'upload-page' && !currentUser) {
            showToast('è¯·å…ˆç™»å½•æ‰èƒ½ä¸Šä¼ è¡¨ç›˜', 'error');
            showDialog('login-dialog');
            showPage('profile-page');
        }
    }

    // åº•éƒ¨å¯¼èˆªæ ç‚¹å‡»äº‹ä»¶
    function handleNavigation(e) {
        e.preventDefault();
        const pageId = this.dataset.page;
        showPage(pageId);
    }

    // æ˜¾ç¤ºå¯¹è¯æ¡†
    function showDialog(id) {
        document.getElementById('auth-backdrop').style.display = 'block';
        document.getElementById(id).style.display = 'block';
    }

    // éšè—æ‰€æœ‰å¯¹è¯æ¡†
    function hideDialogs() {
        document.getElementById('auth-backdrop').style.display = 'none';
        document.querySelectorAll('.auth-dialog').forEach(dialog => {
            dialog.style.display = 'none';
        });
    }

    // å…³é—­å¼¹çª—å‡½æ•°
    function closeModal() {
        const modal = document.getElementById('detail-modal');
        modal.classList.remove('active');
        
        // æ¸…ç†å†…å®¹
        setTimeout(() => {
            document.getElementById('modal-body').innerHTML = '';
        }, 300);
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // éªŒè¯æ–‡ä»¶
    function validateFile(file) {
        if (!file.name.endsWith('.rpk')) {
            showToast('è¯·é€‰æ‹©.rpkæ–‡ä»¶', 'error');
            return false;
        }
        if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
            showToast('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
            return false;
        }
        return true;
    }

    // è§£æRPKæ–‡ä»¶
    async function parseRPK(file) {
        try {
            const zip = new JSZip();
            const contents = await zip.loadAsync(file);
            
            // è¯»å– manifest.json
            const manifestFile = contents.file('manifest.json');
            if (!manifestFile) {
                const errorMsg = 'æ— æ³•æ‰¾åˆ° manifest.json æ–‡ä»¶';
                showToast('RPKè§£æé”™è¯¯: ' + errorMsg, 'error');
                throw new Error(errorMsg);
            }
            
            const manifestContent = await manifestFile.async('text');
            const manifest = JSON.parse(manifestContent);
            
            // å°è¯•åœ¨æ ¹ç›®å½•æŸ¥æ‰¾å›¾æ ‡æ–‡ä»¶
            const allFiles = Object.keys(contents.files);
            const iconFile = allFiles
                .filter(path => !path.includes('/') && /\.(png|jpg|jpeg|vug)$/i.test(path))
                .map(path => contents.file(path))
                .find(file => file !== null);
                
            // å¦‚æœæ‰¾ä¸åˆ°å›¾æ ‡æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡
            let iconBase64 = CONFIG.defaultIcon;
            if (iconFile) {
                const iconBlob = await iconFile.async('blob');
                iconBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(iconBlob);
                });
            } else {
                showToast('æœªæ‰¾åˆ°å›¾æ ‡æ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡', 'warning');
            }
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!manifest.package) {
                const errorMsg = 'ç¼ºå°‘å¿…å¡«å­—æ®µ: package';
                showToast('RPKè§£æé”™è¯¯: ' + errorMsg, 'error');
                throw new Error(errorMsg);
            }
            if (!manifest.name) {
                const errorMsg = 'ç¼ºå°‘å¿…å¡«å­—æ®µ: name';
                showToast('RPKè§£æé”™è¯¯: ' + errorMsg, 'error');
                throw new Error(errorMsg);
            }
            if (!manifest.versionCode) {
                const errorMsg = 'ç¼ºå°‘å¿…å¡«å­—æ®µ: versionCode';
                showToast('RPKè§£æé”™è¯¯: ' + errorMsg, 'error');
                throw new Error(errorMsg);
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè¡¨ç›˜åº”ç”¨
            let appName = manifest.name;
            const isWatchface = manifest.router && manifest.router.watchfaces;
            
            if (isWatchface && !appName.includes('è¡¨ç›˜')) {
                appName = `${appName} (è¡¨ç›˜)`;
            }
            
            // ä»manifestæå–æ•°æ®
            return {
                name: appName,
                package: manifest.package,
                version: manifest.versionName || `${manifest.versionCode}`,
                versionCode: manifest.versionCode,
                icon: iconBase64,
                description: manifest.description || '',
                features: manifest.features || [],
                permissions: manifest.permissions || [],
                appCategory: manifest.categories || ['è¡¨ç›˜'],
                deviceTypeList: manifest.deviceTypes || ['watch'],
                distributionRules: {
                    minAPILevel: manifest.minPlatformVersion || 1
                },
                isWatchface: isWatchface
            };
        } catch (error) {
            // é”™è¯¯å·²ç»åœ¨å…·ä½“æ£€æŸ¥ç‚¹å¤„ç†ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤æ˜¾ç¤º
            throw error;
        }
    }
    
    // æ¸²æŸ“åº”ç”¨åˆ—è¡¨
    function renderApps() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageApps = filteredApps.slice(startIndex, endIndex);
        
        // æ¸…ç©ºå®¹å™¨
        const gridContainer = document.getElementById('app-grid-view');
        const listContainer = document.getElementById('app-list-view');
        gridContainer.innerHTML = '';
        listContainer.innerHTML = '';
        
        // å¦‚æœæ²¡æœ‰åº”ç”¨ï¼Œæ˜¾ç¤ºæç¤º
        if (pageApps.length === 0) {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput ? searchInput.value.trim() : '';
            
            let message = 'æš‚æ— è¡¨ç›˜æ•°æ®';
            if (searchTerm) {
                message = `æ²¡æœ‰æ‰¾åˆ°ä¸"${searchTerm}"ç›¸å…³çš„è¡¨ç›˜`;
            }
            
            gridContainer.innerHTML = `<div class="empty-state"><p>${message}</p></div>`;
            listContainer.innerHTML = `<div class="empty-state"><p>${message}</p></div>`;
            updatePagination();
            return;
        }
        
        // æ¸²æŸ“å½“å‰é¡µçš„åº”ç”¨
        pageApps.forEach(app => {
            // æ ¹æ®å½“å‰è§†å›¾æ¸²æŸ“å¯¹åº”å†…å®¹
            if (currentView === 'grid') {
                renderAppCard(app, gridContainer);
            } else {
                renderAppListItem(app, listContainer);
            }
        });
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        updatePagination();
    }

    // æ›´æ–°åˆ†é¡µæ§ä»¶
    function updatePagination() {
        const totalPages = Math.ceil(filteredApps.length / itemsPerPage);
        const pageNumbers = document.getElementById('page-numbers');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pagination = document.getElementById('pagination');
        
        if (!pagination) return;
        
        if (totalPages <= 1) {
            pagination.style.display = 'none';
            return;
        }
        
        pagination.style.display = 'flex';
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (prevBtn) prevBtn.disabled = currentPage === 1;
        if (nextBtn) nextBtn.disabled = currentPage === totalPages;
        
        // ç”Ÿæˆé¡µç 
        if (pageNumbers) {
            pageNumbers.innerHTML = '';
            
            // æ˜¾ç¤ºæœ€å¤š7ä¸ªé¡µç 
            let startPage = Math.max(1, currentPage - 3);
            let endPage = Math.min(totalPages, startPage + 6);
            
            if (endPage - startPage < 6) {
                startPage = Math.max(1, endPage - 6);
            }
            
            // æ·»åŠ ç¬¬ä¸€é¡µ
            if (startPage > 1) {
                const firstPageBtn = document.createElement('div');
                firstPageBtn.className = 'page-number';
                firstPageBtn.textContent = '1';
                firstPageBtn.addEventListener('click', () => {
                    currentPage = 1;
                    renderApps();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                pageNumbers.appendChild(firstPageBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('div');
                    ellipsis.className = 'page-number';
                    ellipsis.textContent = '...';
                    ellipsis.style.cursor = 'default';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    renderApps();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                pageNumbers.appendChild(pageBtn);
            }
            
            // æ·»åŠ æœ€åä¸€é¡µ
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('div');
                    ellipsis.className = 'page-number';
                    ellipsis.textContent = '...';
                    ellipsis.style.cursor = 'default';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const lastPageBtn = document.createElement('div');
                lastPageBtn.className = 'page-number';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.addEventListener('click', () => {
                    currentPage = totalPages;
                    renderApps();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                pageNumbers.appendChild(lastPageBtn);
            }
        }
    }

    // äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–
    function initializeEventListeners() {
        // å¯¼èˆªæ 
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.dataset.page) {
                link.addEventListener('click', handleNavigation);
            }
        });
        
        // å¼¹çª—å…³é—­
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('detail-modal')) closeModal();
        });
        
        // å›è½¦é”®è§¦å‘æœç´¢
        document.getElementById('search-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchTerm = e.target.value.trim();
                filterApps(searchTerm);
                currentPage = 1;
                renderApps();
                updateSearchStats();
            }
        });
        
        // ç”¨æˆ·åŠŸèƒ½
        document.getElementById('upload-feature').addEventListener('click', () => {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•æ‰èƒ½ä¸Šä¼ è¡¨ç›˜', 'error');
                showDialog('login-dialog');
                return;
            }
            showPage('upload-page');
        });
        
        document.getElementById('my-apps-feature').addEventListener('click', () => {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•æ‰èƒ½æŸ¥çœ‹æˆ‘çš„è¡¨ç›˜', 'error');
                showDialog('login-dialog');
                return;
            }
            showPage('my-apps-page');
        });
        
        // æŒ‰é’®äº‹ä»¶
        document.getElementById('submit-upload').addEventListener('click', handleManualUpload);
        document.getElementById('login-btn').addEventListener('click', () => showDialog('login-dialog'));
        document.getElementById('signup-btn').addEventListener('click', () => showDialog('signup-dialog'));
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            showDialog('reset-password-dialog');
        });
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        
        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
        document.getElementById('app-file').addEventListener('change', handleFileSelectForUpload);
        document.getElementById('app-icon').addEventListener('change', handleIconSelect);
        
        // è®¤è¯å¯¹è¯æ¡†
        document.getElementById('auth-backdrop').addEventListener('click', hideDialogs);
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('signup-form').addEventListener('submit', handleSignup);
        document.getElementById('reset-password-form').addEventListener('submit', handlePasswordReset);
        
        // å®æ—¶å¯†ç éªŒè¯
        document.getElementById('signup-password').addEventListener('input', (e) => {
            const password = e.target.value;
            const isValid = validatePassword(password);
            e.target.style.borderColor = password && !isValid ? '#ff3b30' : '';
        });
        
        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session?.user) {
                currentUser = session.user;
                updateUIForLoggedInUser(currentUser);
                loadMyApps();
                
                // å¦‚æœç”¨æˆ·æ˜¯ä»ä¸Šä¼ é¡µé¢è¿‡æ¥çš„ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ä¸Šä¼ é¡µé¢
                if (document.getElementById('upload-page').classList.contains('active')) {
                    showPage('upload-page');
                }
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                document.getElementById('login-btn').style.display = 'block';
                document.getElementById('signup-btn').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
                document.querySelector('.user-avatar').textContent = 'ğŸ‘¤';
                document.getElementById('user-name').textContent = 'æˆ‘çš„ç©ºé—´';
                
                // å¦‚æœç”¨æˆ·åœ¨ä¸Šä¼ é¡µé¢ï¼Œè·³è½¬åˆ°æˆ‘çš„é¡µé¢
                if (document.getElementById('upload-page').classList.contains('active')) {
                    showPage('profile-page');
                }
            }
        });
    }

    // å¤„ç†å›¾æ ‡é€‰æ‹©
    function handleIconSelect(e) {
        try {
            const file = e.target.files[0];
            if (!file) return;

            // éªŒè¯å›¾ç‰‡æ ¼å¼
            if (!file.type.match('image.*')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                e.target.value = '';
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å°
            if (file.size > 1 * 1024 * 1024) { // 1MBé™åˆ¶
                showToast('å›¾æ ‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡1MB', 'error');
                e.target.value = '';
                return;
            }

            // è¯»å–å¹¶é¢„è§ˆå›¾æ ‡
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('upload-preview');
                preview.innerHTML = '';
                const img = document.createElement('img');
                img.src = event.target.result;
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        } catch (error) {
            showToast('é€‰æ‹©å›¾æ ‡æ—¶å‡ºé”™: ' + error.message, 'error');
            console.error('å›¾æ ‡é€‰æ‹©é”™è¯¯:', error);
            e.target.value = '';
        }
    }
    </script>
</body>
</html>
